<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>多直播觀看工具 Made by Okowa</title>

<style>
body {
  margin: 0;
  padding: 16px;
  background: #000;
  color: #eee;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial;
}

#allStreamsContainer {
  max-width: 1600px;
  margin: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.row {
  display: grid;
  gap: 10px;
}

#topRow {
  grid-template-columns: repeat(2, 1fr);
}

#bottomRow {
  grid-template-columns: repeat(4, 1fr);
}

.stream-wrapper {
  position: relative;
  background: #2c2c2c;
  border-radius: 10px;
  overflow: hidden;
  aspect-ratio: 16 / 9;
}

.stream-wrapper iframe {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  border: none;
}

.add-button {
  position: absolute;
  inset: 0;
  border: 2px dashed #666;
  background: none;
  color: #aaa;
  font-size: 32px;
  cursor: pointer;
}

.add-button:hover {
  border-color: #fff;
  color: #fff;
}

.control {
  position: absolute;
  top: 6px;
  padding: 4px 6px;
  font-size: 13px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  z-index: 5;
}

.close-btn { right: 6px; background: #ff5555; color: #fff; }
.split-btn { left: 6px; background: #444; color: #fff; }

.quad {
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: 1fr 1fr;
  gap: 6px;
}
</style>
</head>

<body>

<div id="allStreamsContainer">
  <div id="topRow" class="row"></div>
  <div id="bottomRow" class="row"></div>
</div>

<script>
const STORAGE_KEY = 'multiLiveLayout_v3';
const topRow = document.getElementById('topRow');
const bottomRow = document.getElementById('bottomRow');

let layout = { top: 2, bottom: 4 };
let slots = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(slots));
}

function updateLayout() {
  const portrait = window.matchMedia('(orientation: portrait)').matches;
  layout = portrait ? { top: 2, bottom: 8 } : { top: 2, bottom: 4 };
  bottomRow.style.gridTemplateColumns = portrait ? 'repeat(2,1fr)' : 'repeat(4,1fr)';
  buildUI();
}

function buildUI() {
  topRow.innerHTML = '';
  bottomRow.innerHTML = '';

  const total = layout.top + layout.bottom;
  while (slots.length < total) slots.push(null);

  for (let i = 0; i < layout.top; i++) {
    topRow.appendChild(renderSlot(i));
  }
  for (let i = layout.top; i < total; i++) {
    bottomRow.appendChild(renderSlot(i));
  }
}

function renderSlot(index) {
  const data = slots[index];
  const box = document.createElement('div');
  box.className = 'stream-wrapper';

  if (!data) {
    const add = document.createElement('button');
    add.className = 'add-button';
    add.textContent = '+';
    add.onclick = () => inputVideo(index);
    box.appendChild(add);
    return box;
  }

  if (data.mode === 'single') {
    addIframe(box, data.videos[0]);
    addControls(box, index, true);
  } else {
    box.classList.add('quad');
    data.videos.forEach(v => {
      const cell = document.createElement('div');
      cell.className = 'stream-wrapper';
      addIframe(cell, v);
      box.appendChild(cell);
    });
    addControls(box, index, false);
  }

  return box;
}

function addIframe(box, id) {
  const iframe = document.createElement('iframe');
  iframe.src = `https://www.youtube.com/embed/${id}?autoplay=1&mute=1`;
  iframe.allow = 'autoplay';
  box.appendChild(iframe);
}

function addControls(box, index, canSplit) {
  const close = document.createElement('button');
  close.className = 'control close-btn';
  close.textContent = '✕';
  close.onclick = () => {
    slots[index] = null;
    save();
    buildUI();
  };
  box.appendChild(close);

  if (canSplit) {
    const split = document.createElement('button');
    split.className = 'control split-btn';
    split.textContent = '⧉';
    split.onclick = () => {
      const id = slots[index].videos[0];
      slots[index] = { mode: 'quad', videos: [id, id, id, id] };
      save();
      buildUI();
    };
    box.appendChild(split);
  }
}

function inputVideo(index) {
  const url = prompt('輸入 YouTube 影片 / 直播網址');
  if (!url) return;
  const id = extractID(url);
  if (!id) return alert('無法解析 YouTube ID');

  slots[index] = { mode: 'single', videos: [id] };
  save();
  buildUI();
}

function extractID(url) {
  const m = url.match(/(?:v=|youtu\.be\/|live\/)([a-zA-Z0-9_-]{11})/);
  return m ? m[1] : null;
}

window.addEventListener('resize', updateLayout);
window.onload = updateLayout;
</script>

</body>
</html>
